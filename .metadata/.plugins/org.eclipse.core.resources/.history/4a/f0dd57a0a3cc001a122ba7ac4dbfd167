package blockChain;

import java.util.Date;
import java.util.List;

/**
 * ??å¡Šé?ˆåŸºç¤æ¶æ§?
 */
public class Block {

	public String hashCode;// hash=?•¸å­—ç°½???

	public String previousHashCode;// ??ä?å¡Šç?„hash

	private List<Transaction> transactions;// è¨˜é?„å?„ç¨®äº¤æ??

	private long timeStamp; // å¾? 1/1/1970?ˆ°?¾?œ¨??„æ¯«ç§’æ•¸ï¼Œç•¶??æ?‚é?“æˆ³ç«?.

	// ??–ç¤¦????äº‚æ•¸
	private int nonce;

	public Block() {

	}

	public Block(List<Transaction> transactions, String previousHashCode) {
		this.transactions = transactions;
		this.previousHashCode = previousHashCode;
		this.timeStamp = new Date().getTime();
		this.hashCode = calculateHash();
	}

	/**
	 * ?‡ªèº«ç?„hash?¼ï?Œæ˜¯?šé?å?å?Šç?„hash?¼ï?Œå?Œè?‡æ?™dataï¼Œå?é?šé?hashè¨ˆç?—å‡ºä¾†ç??
	 */
	public String calculateHash() {

		StringBuilder sb = new StringBuilder();
		for (int i=0; i<transactions.size(); i++) {
			String stringHashCode = Integer.toString(transactions.get(i).hashCode());
			sb.append(stringHashCode);
		}

		String total = previousHashCode + sb.toString() + Long.toString(timeStamp);
		String calculatedhash = EncryptMethod.applySha256(total);

		return calculatedhash;
	}

	/**
	 * ??–ç¤¦
	 * @param difficulty
	 */
	public void mineBlock(int difficulty) {
		
		String miningHash="";
		
		//å»ºç?‹é›£åº?:??è¦å¹¾?‹é›¶
		String target = new String(new char[difficulty]).replace('\0', '0');

		do {
			miningHash = calculateMiningHash();
			nonce++;
		}
		while (!miningHash.substring(0, difficulty).equals(target)); 
		
		System.out.println("Block Mined!!! : " + miningHash);
	}
	
	/**
	 * å·¥ä?œé?ç?—æ??
	 */
	private String calculateMiningHash() {

		StringBuilder sb = new StringBuilder();
		for (int i=0; i<transactions.size(); i++) {
			String stringTransactionHashCode = Integer.toString(transactions.get(i).hashCode());
			sb.append(stringTransactionHashCode);
		}

		String total = previousHashCode + sb.toString() + Long.toString(timeStamp)+Integer.toString(nonce);
		String calculatedMiningHash = EncryptMethod.applySha256(total);

		return calculatedMiningHash;
	}

}